<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">

  <!-- PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#b23a2c">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="BDE PSH">

  <link rel="manifest" href="manifest-public.json">
  <title>BDE PSH SUP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- CSS -->
  <link rel="stylesheet" href="../style.css">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Icons -->
  <link rel="apple-touch-icon" href="../icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="../icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="../icons/icon-512.png">
</head>
<body>

<header class="header">
  <h1>BDE PSH SUP</h1>
  <p>ActualitÃ©s & Ã©vÃ©nements Ã©tudiants</p>
</header>

<main class="admin-grid">

  <button id="installBtn" class="btn-primary hidden">
    ğŸ“² Installer lâ€™application
  </button>

  <button id="notifBtn" class="btn-primary">
    ğŸ”” Activer les notifications
  </button>

</main>

<footer class="footer">
  <p>BDE PSH SUP Â©</p>
</footer>

<script>
/* ===============================
   ğŸ”— SUPABASE
=============================== */
const supabaseUrl = "https://yswqdhoscahtylemhipt.supabase.co";
const supabaseKey = "TA_CLE_ANON";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

/* ===============================
   ğŸ“² SERVICE WORKER
=============================== */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw-public.js")
    .then(reg => console.log("SW public enregistrÃ©", reg))
    .catch(err => console.error("Erreur SW", err));
}

/* ===============================
   ğŸ“² INSTALL PWA
=============================== */
let deferredPrompt;
const installBtn = document.getElementById("installBtn");

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.classList.remove("hidden");
});

installBtn.addEventListener("click", async () => {
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  installBtn.classList.add("hidden");
});

/* ===============================
   ğŸ”” NOTIFICATIONS
=============================== */
const notifBtn = document.getElementById("notifBtn");

notifBtn.addEventListener("click", async () => {
  const permission = await Notification.requestPermission();
  if (permission !== "granted") {
    alert("Notifications refusÃ©es âŒ");
    return;
  }

  const registration = await navigator.serviceWorker.ready;

  const vapidPublicKey = "BGflyhuu28Pgue8ZjnLIJLBjm3cVStbDHU2DQ08Khw_LuduY10nBOTlidcFnVZ7jRvm8IZQexMeS1Ip3NSofi6U";

  const subscription = await registration.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: vapidPublicKey
  });

  const { error } = await supabaseClient
    .from("push_subscriptions")
    .insert([{ subscription }]);

  if (error) {
    console.error(error);
    alert("âŒ Erreur enregistrement notification");
  } else {
    alert("ğŸ”” Notifications activÃ©es !");
  }
});
</script>

</body>
</html>
