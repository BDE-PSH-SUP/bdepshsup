<!DOCTYPE html> 
<html lang="fr"> 
<head>
<meta charset="UTF-8"> 

  <!-- PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes"> 
  <meta name="mobile-web-app-capable" content="yes"> 
  <meta name="theme-color" content="#b23a2c"> 
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> 
  <meta name="apple-mobile-web-app-title" content="BDE PSH"> 
  <link rel="manifest" href="manifest-public.json"> 
  
  <title>BDE PSH SUP</title> 
  
  <meta name="viewport" content="width=device-width, initial-scale=1"> 
  
  <!-- CSS -->
  <link rel="stylesheet" href="style.css">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Icons -->
  <link rel="apple-touch-icon" href="../icons/apple-touch-icon.png"> 
  <link rel="icon" type="image/png" sizes="192x192" href="../icons/icon-192.png"> 
  <link rel="icon" type="image/png" sizes="512x512" href="../icons/icon-512.png"> 

</head>
<body>

<header class="header">
  <h1>BDE PSH SUP</h1>
  <p>La vie Ã©tudiante du campus</p>
</header>

<main class="page">
  <div class="grid">

    <a href="actus.html" class="card" aria-label="Voir les actualitÃ©s">
      <span>ğŸ“°</span>
      <h2>ActualitÃ©s</h2>
    </a>

    <a href="evenements.html" class="card" aria-label="Voir les Ã©vÃ©nements">
      <span>ğŸ“…</span>
      <h2>Ã‰vÃ©nements</h2>
    </a>

    <a href="campus.html" class="card" aria-label="Informations campus">
      <span>ğŸ«</span>
      <h2>Les Campus</h2>
    </a>

    <a href="bde.html" class="card" aria-label="PrÃ©sentation du BDE">
      <span>ğŸ‰</span>
      <h2>Votre BDE</h2>
    </a>

    <!-- ğŸ”” Notifications -->
<div class="notif-bar">
  <button id="notifBtn" class="btn-notif">
    ğŸ”” Activer les notifications
  </button>
</div>


    <!-- ğŸ“² Installer -->
    <button id="installBtn" class="card hidden">
      <span>ğŸ“²</span>
      <h2>Installer lâ€™app</h2>
    </button>

  </div>
</main>

<footer class="footer">
  Â© PSH SUP â€“ Bureau des Ã‰tudiants â€“ 2026
</footer>

<nav class="bottom-nav">
  <a href="actus.html" class="nav-item">
    <span>ğŸ“°</span><small>Actus</small>
  </a>
  <a href="evenements.html" class="nav-item">
    <span>ğŸ“…</span><small>Events</small>
  </a>
  <a href="campus.html" class="nav-item">
    <span>ğŸ«</span><small>Campus</small>
  </a>
  <a href="bde.html" class="nav-item">
    <span>ğŸ‰</span><small>BDE</small>
  </a>
</nav>

<!-- Bouton contact flottant -->
<button id="contactBde" class="btn-contact-floating">âœ‰ï¸</button>
  <!-- Bouton appli campus -->
<button id="campusAppBtn" class="btn-campus-floating">ğŸ«</button>

<script>
/* ===============================
   ğŸ“‹ CONTACT
=============================== */
document.getElementById('contactBde').onclick = () => {
  window.location.href = "mailto:bde.pshsup@passy-st-honore.com";
};

/* ===============================
   APPLI VIE CAMPUS
=============================== */
document.getElementById('campusAppBtn').onclick = () => {
  window.location.href = "https://scolaritepshsup.github.io/PSH-SUP/public/index.html";
};

/* ===============================
   ğŸ”— SUPABASE
=============================== */
const supabaseUrl = "https://yswqdhoscahtylemhipt.supabase.co";
const supabaseKey = "TA_CLE_ANON";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

/* ===============================
   ğŸ”§ SERVICE WORKER
=============================== */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw-public.js")
    .then(reg => console.log("SW public enregistrÃ©", reg))
    .catch(err => console.error("Erreur SW", err));
}

/* ===============================
   ğŸ“² INSTALL PWA
=============================== */
let deferredPrompt;
const installBtn = document.getElementById("installBtn");

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.classList.remove("hidden");
});

installBtn.addEventListener("click", async () => {
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  installBtn.classList.add("hidden");
});

/* ===============================
   ğŸ”” NOTIFICATIONS (CORRIGÃ‰)
=============================== */

function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding)
    .replace(/-/g, '+')
    .replace(/_/g, '/');

  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);

  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

const notifBtn = document.getElementById("notifBtn");

notifBtn.addEventListener("click", async () => {
  try {
    console.log("Demande permissionâ€¦");

    const permission = await Notification.requestPermission();
    if (permission !== "granted") {
      alert("Notifications refusÃ©es âŒ");
      return;
    }

    console.log("Permission OK");

    const registration = await navigator.serviceWorker.ready;

    const vapidPublicKey =
      "BGflyhuu28Pgue8ZjnLIJLBjm3cVStbDHU2DQ08Khw_LuduY10nBOTlidcFnVZ7jRvm8IZQexMeS1Ip3NSofi6U";

    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
    });

    console.log("Subscription:", subscription);

    const { error } = await supabaseClient
      .from("push_subscriptions")
      .insert([{ subscription }]);

    if (error) {
      console.error("Erreur Supabase:", error);
      alert("âŒ Erreur enregistrement notification");
    } else {
      alert("ğŸ”” Notifications activÃ©es !");
    }

  } catch (err) {
    console.error("Erreur notifications:", err);
    alert("Erreur lors de lâ€™activation des notifications");
  }
});
</script>

</body>
</html>
